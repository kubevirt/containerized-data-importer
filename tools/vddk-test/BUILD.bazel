load("@rules_oci//oci:defs.bzl", "oci_image")
load("@rules_pkg//:pkg.bzl", "pkg_tar")

pkg_tar(
    name = "vcenter-govc-tar",
    srcs = ["@vcenter-govc-tar//file"],
    package_dir = "/usr/bin/",
)

pkg_tar(
    name = "vcenter-vcsim-tar",
    srcs = ["@vcenter-vcsim-tar//file"],
    package_dir = "/usr/bin/",
)

pkg_tar(
    name = "entrypoint",
    srcs = [":entrypoint.sh"],
    package_dir = "/usr/bin/",
)

oci_image(
    name = "vcenter-simulator-image",
    base = "//:testimage_base",
    cmd = ["mkdir -p /opt"],
    entrypoint = ["/usr/bin/entrypoint.sh"],
    tars = [
        ":entrypoint",
        ":vcenter-govc-tar",
        ":vcenter-vcsim-tar",
    ],
    visibility = ["//visibility:public"],
)

cc_library(
    name = "vddk-test-plugin",
    srcs = ["vddk-test-plugin.c"],
)

pkg_tar(
    name = "vddk-test-plugin-tar",
    srcs = [":vddk-test-plugin"],
    package_dir = "/",
)

pkg_tar(
    name = "cirros-tar",
    srcs = ["//tests:images/cirros.raw"],
    package_dir = "/",
)

oci_image(
    name = "vddk-test-image",
    base = "//:testimage_base",
    entrypoint = [
        "/bin/sh",
        "-c",
        "mkdir -p /opt/testing && cp -f /libvddk-test-plugin.so /opt/testing/libvddk-test-plugin.so && cp -f /cirros.raw /opt/testing/nbdtest.img",
    ],
    tars = [
        ":cirros-tar",
        ":vddk-test-plugin-tar",
    ],
    user = "1001",
    visibility = ["//visibility:public"],
)
